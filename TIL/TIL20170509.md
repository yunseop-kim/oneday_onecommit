# 역방향 프락시 요청
- 하나의 서버 위에 다양한 컨테이너가 공용 포트를 사용할 때 문제점, 동일한 서비스를 제공하는 컨테이너들이 동일한 포트를 사용할 수 없다는 점.
- 백엔드에서 mysql 서비스 컨테이너 10개가 실행되더라도 오직 한 개의 컨테이너만이 3306 포트를 사용할 수 있음. 
- 웹 서버의 경우에는 여러 컨테이너 중 하나의 컨테이너만이 80 포트를 사용할 수 있다.

## 문제
- 한 호스트 위에 동일한 서비스를 실행하는 컨테이너들이 있으면 문제 발생함. 유저 어플리케이션에서는 공용포트를 사용하기 때문.
- 웹 브라우저에서 워드프레스 실행중인 호스트 아이피 입력하면 기본적으로 80포트로 접근함
- 그래서 각자 개방된 포트를 입력하는 수밖에 없음. 이게 문제.
- host1:12333, host2:12222 ... 이런식으로 접속할 변태는 없다.

## 해결책

### 프락시 서버
- 사용자의 요청을 서비스로 전달해주고, 서비스로부터 요청 결과를 받아 사용자에게 전달해주는 서버
- 트래픽 경로를 설정한다면 사용자는 프락시 서버가 존재하는지조차 눈치챌 수 없으며 모든 것이 이전과 같이 동작함
- 서비스 관리자는 오직 프락시 서버만이 유저와 연결되어 있는 것으로 보이게 됨. 또 다른 유저가 동일한 프락시 서버를 통해 동일한 서비스에 대한 요청을 보낼 경우 서비스 관리자는 기존의 유저와의 차이점을 구분할 수 없으며 동일한 유저로 간주할수 밖에 없게 됨.
- 서비스 관리자는 누군가가 213.12.12.13 ip주소를 가진 프락시 서버와 연결된 것만 확인할 수 있음
- docker host에서 사용자가 요청한 도메인의 종류를 구분하여 올바른 컨테이너 포트로 요청을 전달하며, 컨테이너로부터 응답을 받아 요청한 유저에게 전달하는 역할을 하는 무언가를 모든 컨테이너와 연결되는 앞 부분에 둔다면?
- 이러한 문제를 해결하기 위해 만들어진 것이 역방향 프락시이다.
    - 역방향 프락시 서버는 표준 웹 포트로 사용하는 80 포트를 통해 외부 연결을 기다림.
    - domain1.com 요청이 들어오면 프락시 서버는 설정파일을 참고하여 요청 도메인을 처리할 수 있는 컨테이너가 있는지 확인함
    - 처리할 수 있는 컨테이너가 있으면 역방향 프락시 서버는 요청 내용을 그대로 지정된 컨테이너로 전달함

## nginx를 활용한 문제 해결
- nginx는 http와 역방향 프락시 서버 또는 메일 프락시 서버로 사용되며 이고르 시셰프에 의해 탄생하였습니다. nginx는 오랜 시간동안 Yandex, Mail.Ru, VK, Rambler와 같은 수많은 러시아 사이트 위에서 실행되었습니다. Netcraft에 의하면 2014년 11월까지 약 20.41%의 사이트에서 nginx를 사용하거나 프락시 서버로 사용하였고 넷플릭스, 워드프레스, Fastmail 과 같은 성공적인 서비스에서 사용되고 있습니다.

```conf
upstream wp1 {
    server 127.0.0.1:[포트 번호];
}
server {
    listen 80;
    server_name domain1.com;
    charset UTF-8;
    if ($host !~ ^(domain.com)$ ) {
        return 444;
    }
}

location / {
    proxy_pass http://wp1;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded_Proto $scheme;
    proxy_redirect off;
}
```

